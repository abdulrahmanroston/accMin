
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFA Accounting Dashboard</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Navigation CSS -->
    <link rel="stylesheet" href="tf-navigation.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#1a73e8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--card-background);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--card-background);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-logo {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            gap: 12px;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-icon {
            width: 20px;
            text-align: center;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }

        .header {
            background: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
        }

        .content {
            padding: 32px;
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 24px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stat-primary { color: var(--primary-color); }
        .stat-success { color: var(--success-color); }
        .stat-warning { color: var(--warning-color); }
        .stat-danger { color: var(--danger-color); }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .table th,
        .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-primary);
        }

        .table tbody tr:hover {
            background-color: var(--background-color);
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 24px;
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background-color: #fffbeb;
            color: #92400e;
            border: 1px solid #fed7aa;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 2000;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .header {
                padding: 12px 16px;
                flex-direction: column;
                align-items: flex-start;
            }

            .header-title {
                font-size: 20px;
                margin-bottom: 8px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card-header button {
                width: 100%;
            }

            .table th, .table td {
                padding: 8px;
                font-size: 14px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .modal-content {
                width: 95%;
                max-width: 95%;
            }

            .form-input, .form-label {
                font-size: 16px; /* Larger font size for better touch targets */
            }

            /* Make buttons larger for touch */
            .btn {
                min-height: 44px;
            }

            /* Add mobile menu toggle button */
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                bottom: 20px;
                left: 20px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background-color: var(--primary-color);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                z-index: 2000 !important;
                border: none;
                cursor: pointer;
            }

            /* Hide mobile menu toggle on desktop */
            @media (min-width: 769px) {
                .mobile-menu-toggle {
                    display: none;
                }
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 480px) {
            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .form-actions {
                flex-direction: column;
                gap: 8px;
            }

            .form-actions button {
                width: 100%;
            }

            .pagination {
                flex-wrap: wrap;
            }

            .pagination button {
                margin-bottom: 8px;
            }
        }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Material Select with Search */
        .material-select-container {
            position: relative;
        }

        .material-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none;
        }

        .material-select-dropdown.show {
            display: block;
        }

        .material-select-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .material-select-item:hover {
            background-color: var(--background-color);
        }

        /* Alerts container */
        .alerts-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            width: 300px;
        }

        /* Vault Transfer Modal */
        #vaultTransferModal .form-row {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-calculator"></i>
            </div>
            <h1 class="login-title">Accounting</h1>
            <p class="login-subtitle">Sign in to your account</p>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="phone">Phone Number</label>
                    <input type="tel" id="phone" class="form-input" placeholder="Enter your phone number" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span id="loginText">Sign In</span>
                    <div id="loginLoading" class="loading" style="display: none;"></div>
                </button>
            </form>

            <div id="loginAlert" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="sidebar-title">Accounting</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt nav-icon"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="expenses">
                        <i class="fas fa-receipt nav-icon"></i>
                        Expenses
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="purchases">
                        <i class="fas fa-shopping-cart nav-icon"></i>
                        Purchases
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="vaults">
                        <i class="fas fa-vault nav-icon"></i>
                        Vaults
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="vendors">
                        <i class="fas fa-truck nav-icon"></i>
                        Vendors
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="payroll">
                        <i class="fas fa-money-bill-wave nav-icon"></i>
                        Payroll
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="reports">
                        <i class="fas fa-chart-bar nav-icon"></i>
                        Reports
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="settings">
                        <i class="fas fa-cog nav-icon"></i>
                        Settings
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="userName">Admin User</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Content -->
            <main class="content">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon stat-primary">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value" id="cashBalance">$0.00</div>
                            <div class="stat-label">Cash Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="dailySales">$0.00</div>
                            <div class="stat-label">Daily Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-warning">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <div class="stat-value" id="weeklySales">$0.00</div>
                            <div class="stat-label">Weekly Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-danger">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value" id="monthlySales">$0.00</div>
                            <div class="stat-label">Monthly Sales</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Transactions</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Employee</th>
                                            <th>Amount</th>
                                            <th>Description</th>
                                            <th>Warehouse</th>
                                            <th>Vault</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTransactions">
                                        <tr>
                                            <td colspan="4" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expenses Section -->
                <div id="expensesSection" class="section">
                    <div id="expensesAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Expenses Management</h3>
                            <button class="btn btn-primary btn-sm" onclick="openExpenseModal()">
                                <i class="fas fa-plus"></i>
                                Add Expense
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="expensesSearch" placeholder="Search expenses..." onkeyup="searchTable('expensesTable', 'expensesSearch')">
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th>Description</th>
                                            <th>Warehouse</th>
                                            <th>Vault</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="expensesPagination" class="pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- Purchases Section -->
                <div id="purchasesSection" class="section">
                    <div id="purchasesAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Purchases Management</h3>
                            <button class="btn btn-primary btn-sm" onclick="openPurchaseModal()">
                                <i class="fas fa-plus"></i>
                                Add Purchase
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="purchasesSearch" placeholder="Search purchases..." onkeyup="searchTable('purchasesTable', 'purchasesSearch')">
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Material</th>
                                            <th>Vendor</th>
                                            <th>Quantity</th>
                                            <th>Unit Cost</th>
                                            <th>Total Cost</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchasesTable">
                                        <tr>
                                            <td colspan="7" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="purchasesPagination" class="pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- Vaults Section -->
                <div id="vaultsSection" class="section">
                    <div id="vaultsAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Vaults Management</h3>
                            <div>
                                <button class="btn btn-primary btn-sm" onclick="openVaultModal()">
                                    <i class="fas fa-plus"></i>
                                    Add Vault
                                </button>
                                <button class="btn btn-success btn-sm" onclick="openVaultTransferModal()">
                                    <i class="fas fa-exchange-alt"></i>
                                    Transfer Money
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="openAddFundsModal()">
                                    <i class="fas fa-plus-circle"></i>
                                    Add Funds
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="vaultsSearch" placeholder="Search vaults..." onkeyup="searchTable('vaultsTable', 'vaultsSearch')">
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Payment Method</th>
                                            <th>Balance</th>
                                            <th>Default</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vaultsTable">
                                        <tr>
                                            <td colspan="5" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendors Section -->
                <div id="vendorsSection" class="section">
                    <div id="vendorsAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Vendors Management</h3>
                            <button class="btn btn-primary btn-sm" onclick="openVendorModal()">
                                <i class="fas fa-plus"></i>
                                Add Vendor
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="vendorsSearch" placeholder="Search vendors..." onkeyup="searchTable('vendorsTable', 'vendorsSearch')">
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Address</th>
                                            <th>Balance</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendorsTable">
                                        <tr>
                                            <td colspan="5" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payroll Section -->
                <div id="payrollSection" class="section">
                    <div id="payrollAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Payroll Management</h3>
                            <div>
                                <input type="month" id="payrollMonth" class="form-input" style="width: auto; display: inline-block; margin-right: 10px;">
                                <button class="btn btn-secondary btn-sm" onclick="loadPayroll()">
                                    <i class="fas fa-search"></i>
                                    Filter
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Month</th>
                                            <th>Base Salary</th>
                                            <th>Final Salary</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payrollTable">
                                        <tr>
                                            <td colspan="6" style="text-align: center;">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reportsSection" class="section">
                    <div id="reportsAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Reports & Analytics</h3>
                            <div>
                                <select id="reportPeriod" class="form-input" style="width: auto; display: inline-block; margin-right: 10px;">
                                    <option value="day">Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month" selected>Monthly</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="loadReports()">
                                    <i class="fas fa-refresh"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="reportsContent">
                                <p style="text-align: center;">Loading reports...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="section">
                    <div id="settingsAlert" style="display: none;"></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Settings</h3>
                        </div>
                        <div class="card-body">
                            <form id="settingsForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="currency">Currency</label>
                                        <select id="currency" class="form-input">
                                            <option value="USD">USD</option>
                                            <option value="EGP">EGP</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="mainVault">Main Vault</label>
                                        <select id="mainVault" class="form-input">
                                            <option value="">Select Main Vault</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="reportEmails">Report Emails (comma-separated)</label>
                                    <input type="text" id="reportEmails" class="form-input" placeholder="email1@example.com, email2@example.com">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Save Settings
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="resetTransactions()">
                                        <i class="fas fa-trash"></i>
                                        Reset All Transactions
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="expenseModalAlert" style="display: none;"></div>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="expenseType">Type</label>
                            <select id="expenseType" class="form-input" required>
                                <option value="variable">Variable</option>
                                <option value="fixed">Fixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="expenseCategory">Category</label>
                            <select id="expenseCategory" class="form-input" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="expenseAmount">Amount</label>
                            <input type="number" id="expenseAmount" class="form-input" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="expenseVault">Vault</label>
                            <select id="expenseVault" class="form-input" required>
                                <option value="">Select Vault</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="expenseEmployee">Employee</label>
                            <select id="expenseEmployee" class="form-input" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="expenseWarehouse">Warehouse</label>
                            <select id="expenseWarehouse" class="form-input">
                                <option value="oraby">Oraby</option>
                                <option value="lavista">Lavista</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="expenseDescription">Description</label>
                        <textarea id="expenseDescription" class="form-input" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Expense
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('expenseModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Purchase</h3>
                <button class="modal-close" onclick="closeModal('purchaseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="purchaseModalAlert" style="display: none;"></div>
                <form id="purchaseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="purchaseMaterialSearch">Material</label>
                            <div class="material-select-container">
                                <input type="text" id="purchaseMaterialSearch" class="form-input" placeholder="Search for material..." autocomplete="off">
                                <input type="hidden" id="purchaseMaterial" required>
                                <div id="materialDropdown" class="material-select-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="purchaseVendor">Vendor</label>
                            <select id="purchaseVendor" class="form-input" required>
                                <option value="">Select Vendor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="purchaseQuantity">Quantity</label>
                            <input type="number" id="purchaseQuantity" class="form-input" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="purchaseUnitCost">Unit Cost</label>
                            <input type="number" id="purchaseUnitCost" class="form-input" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="purchaseVault">Vault</label>
                            <select id="purchaseVault" class="form-input" required>
                                <option value="">Select Vault</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="purchaseEmployee">Employee</label>
                            <select id="purchaseEmployee" class="form-input" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Purchase
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('purchaseModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vault Modal -->
    <div id="vaultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Vault</h3>
                <button class="modal-close" onclick="closeModal('vaultModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vaultModalAlert" style="display: none;"></div>
                <form id="vaultForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="vaultName">Vault Name</label>
                            <input type="text" id="vaultName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="vaultPaymentMethod">Payment Method</label>
                            <select id="vaultPaymentMethod" class="form-input" required>
                                <option value="">Select Payment Method</option>
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cod">Cash on Delivery</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="vaultBalance">Initial Balance</label>
                            <input type="number" id="vaultBalance" class="form-input" step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="vaultIsDefault" style="margin-right: 8px;">
                                Default for Payment Method
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Vault
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('vaultModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vault Transfer Modal -->
    <div id="vaultTransferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Money Between Vaults</h3>
                <button class="modal-close" onclick="closeModal('vaultTransferModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vaultTransferModalAlert" style="display: none;"></div>
                <form id="vaultTransferForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="fromVault">From Vault</label>
                            <select id="fromVault" class="form-input" required onchange="updateFromVaultBalance()">
                                <option value="">Select Source Vault</option>
                            </select>
                            <small id="fromVaultBalance" style="display: block; margin-top: 5px; color: var(--text-secondary);">Available: 0.00</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="toVault">To Vault</label>
                            <select id="toVault" class="form-input" required>
                                <option value="">Select Destination Vault</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="transferAmount">Amount</label>
                            <input type="number" id="transferAmount" class="form-input" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="transferEmployee">Employee</label>
                            <select id="transferEmployee" class="form-input" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-exchange-alt"></i>
                            Transfer Money
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('vaultTransferModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div id="addFundsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Funds to Vault</h3>
                <button class="modal-close" onclick="closeModal('addFundsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="addFundsModalAlert" style="display: none;"></div>
                <form id="addFundsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="fundsVault">Vault</label>
                            <select id="fundsVault" class="form-input" required>
                                <option value="">Select Vault</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="fundsAmount">Amount</label>
                            <input type="number" id="fundsAmount" class="form-input" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="fundsEmployee">Employee</label>
                            <select id="fundsEmployee" class="form-input" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="fundsDescription">Description</label>
                            <input type="text" id="fundsDescription" class="form-input" placeholder="Reason for adding funds">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            Add Funds
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addFundsModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vendor Modal -->
    <div id="vendorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Vendor</h3>
                <button class="modal-close" onclick="closeModal('vendorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vendorModalAlert" style="display: none;"></div>
                <form id="vendorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="vendorName">Vendor Name</label>
                            <input type="text" id="vendorName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="vendorPhone">Phone</label>
                            <input type="tel" id="vendorPhone" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="vendorAddress">Address</label>
                        <textarea id="vendorAddress" class="form-input" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Save Vendor
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('vendorModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pay Salary Modal -->
    <div id="paySalaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pay Salary</h3>
                <button class="modal-close" onclick="closeModal('paySalaryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paySalaryModalAlert" style="display: none;"></div>
                <form id="paySalaryForm">
                    <input type="hidden" id="salaryId">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="salaryVault">Vault</label>
                            <select id="salaryVault" class="form-input" required>
                                <option value="">Select Vault</option>
                            </select>
                            <small id="salaryVaultBalance" style="display: block; margin-top: 5px; color: var(--text-secondary);">Available: 0.00</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="salaryEmployee">Employee</label>
                            <select id="salaryEmployee" class="form-input" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-money-bill-wave"></i>
                            Pay Salary
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('paySalaryModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Alerts Container -->
    <div class="alerts-container" id="alertsContainer"></div>


        <div id="tf-navigation"></div>


    <script>
        // Global variables
        let authToken = localStorage.getItem('ffa_token');
        let currentUser = JSON.parse(localStorage.getItem('ffa_user') || '{}');
        const API_BASE = 'https://tenderfrozen.com/wp-json/ffa/v1';
        let allMaterials = []; // Store all materials for search
        let vaultsData = []; // Store vaults data for reference

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken && currentUser.id) {
                showDashboard();
                loadDashboardData();
            } else {
                showLogin();
            }

            // Set current month for payroll
            document.getElementById('payrollMonth').value = new Date().toISOString().slice(0, 7);

            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);

                    // Close sidebar on mobile after navigation
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('show');
                    }
                });
            });

            // Mobile menu toggle
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('show');
            });

            // Forms
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('purchaseForm').addEventListener('submit', handlePurchaseSubmit);
            document.getElementById('vaultForm').addEventListener('submit', handleVaultSubmit);
            document.getElementById('vendorForm').addEventListener('submit', handleVendorSubmit);
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsSubmit);
            document.getElementById('vaultTransferForm').addEventListener('submit', handleVaultTransferSubmit);
            document.getElementById('addFundsForm').addEventListener('submit', handleAddFundsSubmit);
            document.getElementById('paySalaryForm').addEventListener('submit', handlePaySalarySubmit);

            // Material search
            document.getElementById('purchaseMaterialSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const dropdown = document.getElementById('materialDropdown');

                if (searchTerm.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                const filteredMaterials = allMaterials.filter(material => 
                    material.name.toLowerCase().includes(searchTerm)
                );

                if (filteredMaterials.length > 0) {
                    dropdown.innerHTML = '';
                    filteredMaterials.slice(0, 10).forEach(material => {
                        const item = document.createElement('div');
                        item.className = 'material-select-item';
                        item.textContent = material.name;
                        item.addEventListener('click', function() {
                            document.getElementById('purchaseMaterialSearch').value = material.name;
                            document.getElementById('purchaseMaterial').value = material.id;
                            dropdown.classList.remove('show');
                        });
                        dropdown.appendChild(item);
                    });
                    dropdown.classList.add('show');
                } else {
                    dropdown.innerHTML = '<div class="material-select-item">No materials found</div>';
                    dropdown.classList.add('show');
                }
            });

            // Hide material dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.material-select-container')) {
                    document.getElementById('materialDropdown').classList.remove('show');
                }
            });

            // Modal close on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();

            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;

            showLoading('loginLoading', 'loginText', 'Signing in...');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    authToken = data.data.token;
                    currentUser = data.data.employee;

                    localStorage.setItem('ffa_token', authToken);
                    localStorage.setItem('ffa_user', JSON.stringify(currentUser));

                    showDashboard();
                    loadDashboardData();
                    showAlert('Login successful!', 'success');
                } else {
                    showAlert(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Network error. Please try again.', 'error');
            } finally {
                hideLoading('loginLoading', 'loginText', 'Sign In');
            }
        }

        function logout() {
            localStorage.removeItem('ffa_token');
            localStorage.removeItem('ffa_user');
            authToken = null;
            currentUser = {};
            showLogin();
        }

        // UI functions
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name || 'User';
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + 'Section').classList.add('active');

            // Add active class to clicked nav link
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                expenses: 'Expenses Management',
                purchases: 'Purchases Management',
                vaults: 'Vaults Management',
                vendors: 'Vendors Management',
                payroll: 'Payroll Management',
                reports: 'Reports & Analytics',
                settings: 'System Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName] || 'Dashboard';

            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'expenses':
                    loadExpenses();
                    break;
                case 'purchases':
                    loadPurchases();
                    break;
                case 'vaults':
                    loadVaults();
                    break;
                case 'vendors':
                    loadVendors();
                    break;
                case 'payroll':
                    loadPayroll();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        function showAlert(message, type, containerId = null) {
            const alertElement = document.createElement('div');
            alertElement.className = `alert alert-${type}`;
            alertElement.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;

            if (containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(alertElement);
                    container.style.display = 'block';
                }
            } else {
                // Show in global alerts container
                const alertsContainer = document.getElementById('alertsContainer');
                alertsContainer.appendChild(alertElement);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                }, 5000);
            }
        }

        function showLoading(loadingId, textId, loadingText) {
            const loadingElement = document.getElementById(loadingId);
            const textElement = document.getElementById(textId);
            if (loadingElement) loadingElement.style.display = 'inline-block';
            if (textElement) textElement.textContent = loadingText;
        }

        function hideLoading(loadingId, textId, originalText) {
            const loadingElement = document.getElementById(loadingId);
            const textElement = document.getElementById(textId);
            if (loadingElement) loadingElement.style.display = 'none';
            if (textElement) textElement.textContent = originalText;
        }

        // API functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(url, config);

                if (response.status === 401) {
                    logout();
                    showAlert('Session expired. Please login again.', 'error');
                    throw new Error('Session expired');
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                const data = await apiRequest('/dashboard');

                if (data.status === 'success') {
                    const currency = data.data.currency || 'USD';
                    document.getElementById('cashBalance').textContent = `${currency} ${formatNumber(data.data.cash_balance)}`;
                    document.getElementById('dailySales').textContent = `${currency} ${formatNumber(data.data.daily_sales.total)}`;
                    document.getElementById('weeklySales').textContent = `${currency} ${formatNumber(data.data.weekly_sales.total)}`;
                    document.getElementById('monthlySales').textContent = `${currency} ${formatNumber(data.data.monthly_sales.total)}`;
                }

                // Load recent transactions
                loadRecentTransactions();
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                // Set default values on error
                document.getElementById('cashBalance').textContent = '$0.00';
                document.getElementById('dailySales').textContent = '$0.00';
                document.getElementById('weeklySales').textContent = '$0.00';
                document.getElementById('monthlySales').textContent = '$0.00';
            }
        }

        async function loadRecentTransactions() {
            try {
                const data = await apiRequest('/cashflow?per_page=15');

                if (data.status === 'success') {
                    const tbody = document.getElementById('recentTransactions');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No transactions found</td></tr>';
                        return;
                    }

                    data.data.forEach(transaction => {
                        console.log(transaction)
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <span class="badge ${transaction.type === 'revenue' ? 'badge-success' : 'badge-danger'}">
                                    ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                                </span>
                            </td>
                            <td>${transaction.employee_name || 'Order'}</td>
                            <td>${formatNumber(transaction.amount)}</td>
                            <td>${transaction.description || '-'}</td>
                            <td>${transaction.warehouse || '-'}</td>
                            <td>${transaction.vault_name || '-'}</td>
                            <td>${formatDate(transaction.created_at)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load recent transactions:', error);
                document.getElementById('recentTransactions').innerHTML = '<tr><td colspan="4" style="text-align: center;">Failed to load transactions</td></tr>';
            }
        }

        // Expenses functions
        async function loadExpenses(page = 1) {
            try {
                const data = await apiRequest(`/expenses?page=${page}&per_page=10`);

                if (data.status === 'success') {
                    const tbody = document.getElementById('expensesTable');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No expenses found</td></tr>';
                        return;
                    }

                    data.data.forEach(expense => {
                        console.log(expense)
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${expense.employee_name}</td>
                            <td>${expense.category_name || 'Uncategorized'}</td>
                            <td>${formatNumber(expense.amount)}</td>
                            <td>${expense.description || '-'}</td>
                            <td>${expense.warehouse || '-'}</td>
                            <td>${expense.vault_name || '-'}</td>
                            <td>${formatDate(expense.created_at)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update pagination
                    updatePagination('expensesPagination', data.pagination, loadExpenses);
                }
            } catch (error) {
                console.error('Failed to load expenses:', error);
                document.getElementById('expensesTable').innerHTML = '<tr><td colspan="6" style="text-align: center;">Failed to load expenses</td></tr>';
            }
        }

        async function openExpenseModal() {
            // Load categories, vaults, and employees
            await Promise.all([
                loadExpenseCategories(),
                loadVaultsForSelect('expenseVault'),
                loadEmployeesForSelect('expenseEmployee')
            ]);

            // Set current employee as default
            const employeeSelect = document.getElementById('expenseEmployee');
            if (employeeSelect && currentUser.id) {
                for (let i = 0; i < employeeSelect.options.length; i++) {
                    if (employeeSelect.options[i].value == currentUser.id) {
                        employeeSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            document.getElementById('expenseModal').classList.add('show');
        }

        async function loadExpenseCategories() {
            try {
                const data = await apiRequest('/expense-categories');

                if (data.status === 'success') {
                    const select = document.getElementById('expenseCategory');
                    if (select) {
                        select.innerHTML = '<option value="">Select Category</option>';

                        data.data.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = `${category.name} (${category.description})`; 
    select.appendChild(option);
});
                    }
                }
            } catch (error) {
                console.error('Failed to load expense categories:', error);
            }
        }

        async function handleExpenseSubmit(e) {
            e.preventDefault();

            const formData = {
                type: document.getElementById('expenseType').value,
                category_id: document.getElementById('expenseCategory').value,
                amount: document.getElementById('expenseAmount').value,
                vault_id: document.getElementById('expenseVault').value,
                employee_id: document.getElementById('expenseEmployee').value,
                warehouse: document.getElementById('expenseWarehouse').value,
                description: document.getElementById('expenseDescription').value
            };

            try {
                const data = await apiRequest('/expenses', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('expenseModal');
                    loadExpenses();
                    showAlert('Expense added successfully!', 'success');
                    document.getElementById('expenseForm').reset();
                }
            } catch (error) {
                console.error('Failed to add expense:', error);
                showAlert(error.message, 'error', 'expenseModalAlert');
            }
        }

      async function deleteExpense(id) {
    if (!confirm('Are you sure you want to delete this expense? The amount will be returned to the vault.')) {
        return;
    }

    try {
        // First get expense details to know which vault to return money to
        const expenseData = await apiRequest(`/expenses/${id}`);

        if (expenseData.status === 'success') {
            const expense = expenseData.data;
            const vaultId = expense.vault_id;
            const amount = parseFloat(expense.amount);

            // Get current vault balance
            const vaultData = await apiRequest(`/vaults/${vaultId}`);

            if (vaultData.status === 'success') {
                const currentBalance = parseFloat(vaultData.data.balance);
                const newBalance = currentBalance + amount;

                // Delete the expense
                const deleteData = await apiRequest(`/expenses/${id}`, {
                    method: 'DELETE'
                });

                if (deleteData.status === 'success') {
                    // Update vault balance to return the money
                    const updateVaultData = await apiRequest(`/vaults/${vaultId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            balance: newBalance,
                            updated_by: currentUser.id,
                            update_reason: `Expense deleted - returned ${amount}`
                        })
                    });

                    if (updateVaultData.status === 'success') {
                        loadExpenses();
                        loadDashboardData(); // Refresh dashboard to show updated balances
                        showAlert(`Expense deleted successfully! ${formatNumber(amount)} returned to vault.`, 'success');
                    } else {
                        // Expense was deleted but vault update failed
                        loadExpenses();
                        showAlert('Expense deleted but failed to return money to vault. Please check vault balance manually.', 'warning');
                    }
                } else {
                    showAlert('Failed to delete expense.', 'error');
                }
            } else {
                showAlert('Failed to get vault information. Cannot return money.', 'error');
            }
        } else {
            showAlert('Failed to get expense details.', 'error');
        }

    } catch (error) {
        console.error('Failed to delete expense:', error);
        showAlert(error.message || 'Failed to delete expense', 'error');
    }
}

        // Purchases functions
        async function loadPurchases(page = 1) {
            try {
                const data = await apiRequest(`/purchases?page=${page}&per_page=10`);

                if (data.status === 'success') {
                    const tbody = document.getElementById('purchasesTable');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No purchases found</td></tr>';
                        return;
                    }

                    data.data.forEach(purchase => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${purchase.material_name || 'Unknown'}</td>
                            <td>${purchase.vendor_name || 'Unknown'}</td>
                            <td>${purchase.quantity}</td>
                            <td>${formatNumber(purchase.unit_cost)}</td>
                            <td>${formatNumber(purchase.total_cost)}</td>
                            <td>${formatDate(purchase.created_at)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deletePurchase(${purchase.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update pagination
                    updatePagination('purchasesPagination', data.pagination, loadPurchases);
                }
            } catch (error) {
                console.error('Failed to load purchases:', error);
                document.getElementById('purchasesTable').innerHTML = '<tr><td colspan="7" style="text-align: center;">Failed to load purchases</td></tr>';
            }
        }

        async function openPurchaseModal() {
            // Load materials, vendors, vaults, and employees
            await Promise.all([
                loadMaterialsForSelect(),
                loadVendorsForSelect('purchaseVendor'),
                loadVaultsForSelect('purchaseVault'),
                loadEmployeesForSelect('purchaseEmployee')
            ]);

            // Set current employee as default
            const employeeSelect = document.getElementById('purchaseEmployee');
            if (employeeSelect && currentUser.id) {
                for (let i = 0; i < employeeSelect.options.length; i++) {
                    if (employeeSelect.options[i].value == currentUser.id) {
                        employeeSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            document.getElementById('purchaseModal').classList.add('show');
        }

        async function loadMaterialsForSelect() {
    try {
        // Try to load materials from multiple API endpoints
        let materials = [];
        let loaded = false;

        // Try FMS API first
        try {
            const fmsResponse = await fetch('https://tenderfrozen.com/wp-json/fms/v1/materials', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            if (fmsResponse.ok) {
                const fmsData = await fmsResponse.json();
                if (fmsData.status === 'success' && Array.isArray(fmsData.data)) {
                    materials = fmsData.data.map(material => ({
                        id: material.id,
                        name: material.name || material.title
                    }));
                    loaded = true;
                    console.log(`Loaded ${materials.length} materials from FMS API`);
                }
            }
        } catch (fmsError) {
            console.log('FMS API not available, trying WordPress API...');
        }

        // If FMS failed, try WordPress posts API
        if (!loaded) {
            try {
                const wpResponse = await fetch('https://tenderfrozen.com/wp-json/wp/v2/material?per_page=200&_fields=id,title');

                if (wpResponse.ok) {
                    const wpMaterials = await wpResponse.json();
                    if (Array.isArray(wpMaterials)) {
                        materials = wpMaterials.map(material => ({
                            id: material.id,
                            name: material.title.rendered
                        }));
                        loaded = true;
                        console.log(`Loaded ${materials.length} materials from WordPress API`);
                    }
                }
            } catch (wpError) {
                console.log('WordPress API not available...');
            }
        }

        // If still no materials, try custom post type
        if (!loaded) {
            try {
                const customResponse = await fetch('https://tenderfrozen.com/wp-json/wp/v2/materials?per_page=200&_fields=id,title');

                if (customResponse.ok) {
                    const customMaterials = await customResponse.json();
                    if (Array.isArray(customMaterials)) {
                        materials = customMaterials.map(material => ({
                            id: material.id,
                            name: material.title.rendered
                        }));
                        loaded = true;
                        console.log(`Loaded ${materials.length} materials from Custom API`);
                    }
                }
            } catch (customError) {
                console.log('Custom materials API not available...');
            }
        }

        // Set loaded materials
        allMaterials = materials;

        if (materials.length === 0) {
            console.log('No materials found from any API');
            showAlert('No materials found. Please check server connection.', 'warning');
        } else {
            console.log(`Successfully loaded ${materials.length} materials`);
        }

    } catch (error) {
        console.error('Failed to load materials:', error);
        allMaterials = [];
        showAlert('Error loading materials. Please try again.', 'error', 'purchaseModalAlert');
    }
}

        async function handlePurchaseSubmit(e) {
            e.preventDefault();

            const materialId = document.getElementById('purchaseMaterial').value;
            if (!materialId) {
                showAlert('Please select a material', 'error', 'purchaseModalAlert');
                return;
            }

            const formData = {
                material_id: materialId,
                vendor_id: document.getElementById('purchaseVendor').value,
                quantity: document.getElementById('purchaseQuantity').value,
                unit_cost: document.getElementById('purchaseUnitCost').value,
                vault_id: document.getElementById('purchaseVault').value,
                employee_id: document.getElementById('purchaseEmployee').value
            };

            try {
                const data = await apiRequest('/purchases', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('purchaseModal');
                    loadPurchases();
                    showAlert('Purchase added successfully!', 'success');
                    document.getElementById('purchaseForm').reset();
                    document.getElementById('purchaseMaterialSearch').value = '';
                    document.getElementById('purchaseMaterial').value = '';
                }
            } catch (error) {
                console.error('Failed to add purchase:', error);
                showAlert(error.message, 'error', 'purchaseModalAlert');
            }
        }

        async function deletePurchase(id) {
            if (!confirm('Are you sure you want to delete this purchase?')) {
                return;
            }

            try {
                const data = await apiRequest(`/purchases/${id}`, {
                    method: 'DELETE'
                });

                if (data.status === 'success') {
                    loadPurchases();
                    showAlert('Purchase deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Failed to delete purchase:', error);
                showAlert(error.message, 'error');
            }
        }

        // Vaults functions
        async function loadVaults() {
            try {
                const data = await apiRequest('/vaults');

                if (data.status === 'success') {
                    vaultsData = data.data; // Store for reference
                    const tbody = document.getElementById('vaultsTable');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No vaults found</td></tr>';
                        return;
                    }

                    data.data.forEach(vault => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${vault.name}</td>
                            <td>${vault.payment_method.replace('_', ' ').toUpperCase()}</td>
                            <td>${formatNumber(vault.balance)}</td>
                            <td>${vault.is_default ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteVault(${vault.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load vaults:', error);
                document.getElementById('vaultsTable').innerHTML = '<tr><td colspan="5" style="text-align: center;">No vaults found</td></tr>';
            }
        }

        async function loadVaultsForSelect(selectId) {
            try {
                const data = await apiRequest('/vaults');

                if (data.status === 'success') {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Vault</option>';

                        data.data.forEach(vault => {
                            const option = document.createElement('option');
                            option.value = vault.id;
                            option.textContent = `${vault.name} (${formatNumber(vault.balance)})`;
                            option.dataset.balance = vault.balance;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load vaults for select:', error);
            }
        }

        function openVaultModal() {
            document.getElementById('vaultModal').classList.add('show');
        }

        async function openVaultTransferModal() {
            await Promise.all([
                loadVaultsForSelect('fromVault'),
                loadVaultsForSelect('toVault'),
                loadEmployeesForSelect('transferEmployee')
            ]);

            // Set current employee as default
            const employeeSelect = document.getElementById('transferEmployee');
            if (employeeSelect && currentUser.id) {
                for (let i = 0; i < employeeSelect.options.length; i++) {
                    if (employeeSelect.options[i].value == currentUser.id) {
                        employeeSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            document.getElementById('vaultTransferModal').classList.add('show');
        }

        async function openAddFundsModal() {
            await Promise.all([
                loadVaultsForSelect('fundsVault'),
                loadEmployeesForSelect('fundsEmployee')
            ]);

            // Set current employee as default
            const employeeSelect = document.getElementById('fundsEmployee');
            if (employeeSelect && currentUser.id) {
                for (let i = 0; i < employeeSelect.options.length; i++) {
                    if (employeeSelect.options[i].value == currentUser.id) {
                        employeeSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            document.getElementById('addFundsModal').classList.add('show');
        }

        function updateFromVaultBalance() {
            const fromVaultSelect = document.getElementById('fromVault');
            const balanceDisplay = document.getElementById('fromVaultBalance');

            if (fromVaultSelect.selectedIndex > 0) {
                const selectedOption = fromVaultSelect.options[fromVaultSelect.selectedIndex];
                const balance = selectedOption.dataset.balance || 0;
                balanceDisplay.textContent = `Available: ${formatNumber(balance)}`;
            } else {
                balanceDisplay.textContent = 'Available: 0.00';
            }
        }

        async function handleVaultSubmit(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('vaultName').value,
                payment_method: document.getElementById('vaultPaymentMethod').value,
                balance: document.getElementById('vaultBalance').value,
                is_default: document.getElementById('vaultIsDefault').checked ? 1 : 0,
                employees: []
            };

            try {
                const data = await apiRequest('/vaults', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('vaultModal');
                    loadVaults();
                    showAlert('Vault added successfully!', 'success');
                    document.getElementById('vaultForm').reset();
                }
            } catch (error) {
                console.error('Failed to add vault:', error);
                showAlert(error.message, 'error', 'vaultModalAlert');
            }
        }

        async function handleVaultTransferSubmit(e) {
            e.preventDefault();

            const formData = {
                from_vault_id: document.getElementById('fromVault').value,
                to_vault_id: document.getElementById('toVault').value,
                amount: document.getElementById('transferAmount').value,
                employee_id: document.getElementById('transferEmployee').value
            };

            try {
                const data = await apiRequest('/vaults/transfer', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('vaultTransferModal');
                    loadVaults();
                    loadDashboardData();
                    showAlert('Money transferred successfully!', 'success');
                    document.getElementById('vaultTransferForm').reset();
                }
            } catch (error) {
                console.error('Failed to transfer money:', error);
                showAlert(error.message, 'error', 'vaultTransferModalAlert');
            }
        }

        async function handleAddFundsSubmit(e) {
            e.preventDefault();

            const vaultId = document.getElementById('fundsVault').value;
            const amount = parseFloat(document.getElementById('fundsAmount').value);
            const description = document.getElementById('fundsDescription').value || 'Funds added to vault';

            try {
                // Get current vault balance
                const vaultData = await apiRequest(`/vaults/${vaultId}`);
                const currentBalance = parseFloat(vaultData.data.balance);
                const newBalance = currentBalance + amount;

                // Update vault balance
                const updateData = await apiRequest(`/vaults/${vaultId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ balance: newBalance })
                });

                if (updateData.status === 'success') {
                    closeModal('addFundsModal');
                    loadVaults();
                    loadDashboardData();
                    showAlert('Funds added successfully!', 'success');
                    document.getElementById('addFundsForm').reset();
                }
            } catch (error) {
                console.error('Failed to add funds:', error);
                showAlert(error.message, 'error', 'addFundsModalAlert');
            }
        }

        async function deleteVault(id) {
            if (!confirm('Are you sure you want to delete this vault?')) {
                return;
            }

            try {
                const data = await apiRequest(`/vaults/${id}`, {
                    method: 'DELETE'
                });

                if (data.status === 'success') {
                    loadVaults();
                    showAlert('Vault deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Failed to delete vault:', error);
                showAlert(error.message, 'error');
            }
        }

        // Vendors functions
        async function loadVendors() {
            try {
                const data = await apiRequest('/vendors');

                if (data.status === 'success') {
                    const tbody = document.getElementById('vendorsTable');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No vendors found</td></tr>';
                        return;
                    }

                    data.data.forEach(vendor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${vendor.name}</td>
                            <td>${vendor.phone || '-'}</td>
                            <td>${vendor.address || '-'}</td>
                            <td>${formatNumber(vendor.balance)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteVendor(${vendor.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load vendors:', error);
                document.getElementById('vendorsTable').innerHTML = '<tr><td colspan="5" style="text-align: center;">No vendors found</td></tr>';
            }
        }

        async function loadVendorsForSelect(selectId) {
            try {
                const data = await apiRequest('/vendors');

                if (data.status === 'success') {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Vendor</option>';

                        data.data.forEach(vendor => {
                            const option = document.createElement('option');
                            option.value = vendor.id;
                            option.textContent = vendor.name;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load vendors for select:', error);
            }
        }

        function openVendorModal() {
            document.getElementById('vendorModal').classList.add('show');
        }

        async function handleVendorSubmit(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('vendorName').value,
                phone: document.getElementById('vendorPhone').value,
                address: document.getElementById('vendorAddress').value,
                material_ids: [],
                payment_methods: []
            };

            try {
                const data = await apiRequest('/vendors', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('vendorModal');
                    loadVendors();
                    showAlert('Vendor added successfully!', 'success');
                    document.getElementById('vendorForm').reset();
                }
            } catch (error) {
                console.error('Failed to add vendor:', error);
                showAlert(error.message, 'error', 'vendorModalAlert');
            }
        }

        async function deleteVendor(id) {
            if (!confirm('Are you sure you want to delete this vendor?')) {
                return;
            }

            try {
                const data = await apiRequest(`/vendors/${id}`, {
                    method: 'DELETE'
                });

                if (data.status === 'success') {
                    loadVendors();
                    showAlert('Vendor deleted successfully!', 'success');
                }
            } catch (error) {
                console.error('Failed to delete vendor:', error);
                showAlert(error.message, 'error');
            }
        }

        // Payroll functions
        async function loadPayroll() {
            const month = document.getElementById('payrollMonth').value;

            try {
                const data = await apiRequest(`/payroll?month=${month}`);

                if (data.status === 'success') {
                    const tbody = document.getElementById('payrollTable');
                    tbody.innerHTML = '';

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No payroll data found for this month</td></tr>';
                        return;
                    }

                    data.data.forEach(salary => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${salary.name}</td>
                            <td>${salary.month}</td>
                            <td>${formatNumber(salary.base_salary)}</td>
                            <td>${formatNumber(salary.final_salary)}</td>
                            <td>
                                <span class="badge ${salary.status === 'paid' ? 'badge-success' : 'badge-warning'}">
                                    ${salary.status || 'unpaid'}
                                </span>
                            </td>
                            <td>
                                ${salary.status !== 'paid' ? `
                                    <button class="btn btn-success btn-sm" onclick="openPaySalaryModal(${salary.id}, '${salary.name}', ${salary.final_salary})">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Pay
                                    </button>
                                ` : 'Paid'}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Failed to load payroll:', error);
                document.getElementById('payrollTable').innerHTML = '<tr><td colspan="6" style="text-align: center;">Failed to load payroll data</td></tr>';
            }
        }

        async function openPaySalaryModal(salaryId, employeeName, amount) {
            document.getElementById('salaryId').value = salaryId;

            await Promise.all([
                loadVaultsForSelect('salaryVault'),
                loadEmployeesForSelect('salaryEmployee')
            ]);

            // Set current employee as default
            const employeeSelect = document.getElementById('salaryEmployee');
            if (employeeSelect && currentUser.id) {
                for (let i = 0; i < employeeSelect.options.length; i++) {
                    if (employeeSelect.options[i].value == currentUser.id) {
                        employeeSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            document.getElementById('paySalaryModal').classList.add('show');
        }

        async function handlePaySalarySubmit(e) {
            e.preventDefault();

            const formData = {
                salary_id: document.getElementById('salaryId').value,
                vault_id: document.getElementById('salaryVault').value,
                employee_id: document.getElementById('salaryEmployee').value
            };

            try {
                const data = await apiRequest('/payroll/pay', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    closeModal('paySalaryModal');
                    loadPayroll();
                    loadDashboardData();
                    showAlert('Salary paid successfully!', 'success');
                    document.getElementById('paySalaryForm').reset();
                }
            } catch (error) {
                console.error('Failed to pay salary:', error);
                showAlert(error.message, 'error', 'paySalaryModalAlert');
            }
        }

        // Reports functions
        async function loadReports() {
            const period = document.getElementById('reportPeriod').value;

            try {
                const data = await apiRequest(`/reports?period=${period}`);

                if (data.status === 'success') {
                    const content = document.getElementById('reportsContent');
                    const currency = data.data.currency || 'USD';

                    content.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon stat-success">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-value">${currency} ${formatNumber(data.data.sales_report.total)}</div>
                                <div class="stat-label">Total Sales (${period.charAt(0).toUpperCase() + period.slice(1)})</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon stat-primary">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-value">${formatNumber(data.data.profit_margin)}%</div>
                                <div class="stat-label">Profit Margin</div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h3 class="card-title">Sales by Warehouse</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Warehouse</th>
                                                <th>Total Sales</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.data.sales_report.by_warehouse.map(sale => `
                                                <tr>
                                                    <td>${sale.warehouse || 'Unknown'}</td>
                                                    <td>${currency} ${formatNumber(sale.total)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load reports:', error);
                document.getElementById('reportsContent').innerHTML = '<p style="text-align: center; color: var(--danger-color);">Failed to load reports</p>';
            }
        }

        // Settings functions
        async function loadSettings() {
            try {
                const data = await apiRequest('/settings');

                if (data.status === 'success') {
                    document.getElementById('currency').value = data.data.currency || 'USD';
                    document.getElementById('reportEmails').value = (data.data.report_emails || []).join(', ');

                    // Load main vault options
                    const mainVaultSelect = document.getElementById('mainVault');
                    mainVaultSelect.innerHTML = '<option value="">Select Main Vault</option>';

                    if (data.data.available_vaults) {
                        data.data.available_vaults.forEach(vault => {
                            const option = document.createElement('option');
                            option.value = vault.id;
                            option.textContent = vault.name;
                            option.selected = vault.id == data.data.main_vault;
                            mainVaultSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function handleSettingsSubmit(e) {
            e.preventDefault();

            const formData = {
                currency: document.getElementById('currency').value,
                main_vault: document.getElementById('mainVault').value,
                report_emails: document.getElementById('reportEmails').value.split(',').map(email => email.trim()).filter(email => email)
            };

            try {
                const data = await apiRequest('/settings', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (data.status === 'success') {
                    showAlert('Settings saved successfully!', 'success');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                showAlert(error.message, 'error', 'settingsAlert');
            }
        }

        async function resetTransactions() {
            if (!confirm('Are you sure you want to reset ALL transactions? This action cannot be undone!')) {
                return;
            }

            if (!confirm('This will delete all expenses, purchases, and reset all balances. Are you absolutely sure?')) {
                return;
            }

            try {
                const data = await apiRequest('/reset-transactions', {
                    method: 'POST'
                });

                if (data.status === 'success') {
                    showAlert('All transactions have been reset successfully!', 'success');
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Failed to reset transactions:', error);
                showAlert(error.message, 'error', 'settingsAlert');
            }
        }

        // Helper functions
        async function loadEmployeesForSelect(selectId) {
            try {
                // Try to load from SHRMS API
                const response = await fetch('https://tenderfrozen.com/wp-json/shrms/v1/employees', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const select = document.getElementById(selectId);
                if (!select) return;

                select.innerHTML = '<option value="">Select Employee</option>';

                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && Array.isArray(data.data)) {
                        data.data.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.id;
                            option.textContent = employee.name;
                            select.appendChild(option);
                        });
                        return;
                    }
                }

                // Fallback: add current user
                if (currentUser.id && currentUser.name) {
                    const option = document.createElement('option');
                    option.value = currentUser.id;
                    option.textContent = currentUser.name;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load employees:', error);

                // Fallback: add current user
                const select = document.getElementById(selectId);
                if (select && currentUser.id && currentUser.name) {
                    select.innerHTML = '<option value="">Select Employee</option>';
                    const option = document.createElement('option');
                    option.value = currentUser.id;
                    option.textContent = currentUser.name;
                    select.appendChild(option);
                }
            }
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number || 0);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updatePagination(containerId, pagination, loadFunction) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            if (pagination.total_pages <= 1) {
                return;
            }

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = pagination.page <= 1;
            prevBtn.onclick = () => loadFunction(pagination.page - 1);
            container.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= pagination.total_pages; i++) {
                if (i === pagination.page || 
                    i === 1 || 
                    i === pagination.total_pages || 
                    (i >= pagination.page - 2 && i <= pagination.page + 2)) {

                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = i === pagination.page ? 'active' : '';
                    pageBtn.onclick = () => loadFunction(i);
                    container.appendChild(pageBtn);
                } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '8px';
                    container.appendChild(dots);
                }
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = pagination.page >= pagination.total_pages;
            nextBtn.onclick = () => loadFunction(pagination.page + 1);
            container.appendChild(nextBtn);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function searchTable(tableId, searchId) {
            const searchTerm = document.getElementById(searchId).value.toLowerCase();
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) { // Skip header row
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < cells.length - 1; j++) { // Skip actions column
                    if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }

                row.style.display = found ? '' : 'none';
            }
        }
        

    </script>
</body>
</html>
